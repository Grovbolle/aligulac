{% extends "index.html" %}

{% comment %}
This is the template for the main player page, called from ratings.views.player.
{% endcomment %}

{% load ratings_extras %}
{% load formulation %}

{% block title %}{{ player.tag }}{% endblock %}

{% block content %}
    <h2>{{ player.tag }}</h2>

    {% include "messages.html" %}

    <div class="ibox" style="width: 25em;">
        <div class="iboxh">
            {{ player.tag }}
            {% if adm %} 
            (<a href="#" onclick="toggle_form(); hide_charts(); return false;">edit</a>, 
            <a href="/admin/ratings/player/{{ player.id }}/">admin</a>)
            {% endif %}
        </div>
        <div class="iboxtable">
            <div class="row">
                <div class="rowel" style="width: 10em;">Race</div>
                <div class="rower" style="width: 20em;">
                    <img src="{{ player.race|imgfolder|static }}" class="btm" />
                    {{ player.race|racefull }}
                </div>
            </div>
            {% if player.country %}
            <div class="row infobox">
                <div class="rowel">Country</div>
                <div class="rower">
                    {% if player.country != "" %}
                    <img src="{{ player.country|lower|imgfolder:"flags"|static }}" class="btm" />
                    {{ countryfull }}
                    {% endif %}
                </div>
            </div>
            {% endif %}
            {% if player.name %}
            <div class="row infobox">
                <div class="rowel">Full name</div>
                <div class="rower">{{ player.name }}</div>
            </div>
            {% endif %}
            {% if aliases %}
            <div class="row infobox">
                <div class="rowel">AKA</div>
                <div class="rower">{% for alias in aliases %}{{ alias.name }}{% if not forloop.last %}, {% endif %}{% endfor %}</div>
            </div>
            {% endif %}
            {% if player.birthday %}
            <div class="row infobox">
                <div class="rowel">Birthday</div>
                <div class="rower">{{ player.birthday|date:"F jS, Y" }}</div>
            </div>
            {% endif %}
            {% if team %}
            <div class="row">
                <div class="rowel">Team</div>
                <div class="rower"><a href="/teams/{{ team.id }}-{{ team.name|urlfilter }}/">{{ team.name }}</a></div>
            </div>
            {% endif %}
            {% if first %}
            <div class="row">
                <div class="rowel">First match</div>
                <div class="rower">{{ first.date|date:"F jS, Y" }}</div>
            </div>
            {% endif %}
            {% if last %}
            <div class="row">
                <div class="rowel">Last match</div>
                <div class="rower">{{ last.date|date:"F jS, Y" }}</div>
            </div>
            {% endif %}
            {% if earnings %}
            <div class="row">
                <div class="rowel">Total earnings</div>
                <div class="rower">${{ earnings|add_separator }}</div>
            </div>
            {% endif %}
            <div class="row">
                <div class="rowel">Matches played</div>
                <div class="rower">{{ totalmatches }}</div>
            </div>
            <div class="row">
                <div class="rowel">Offline matches</div>
                <div class="rower">{{ offlinematches|pctg:totalmatches }}%</div>
            </div>
            {% if player.mcnum or player.mcnum == 0 %}
            <div class="row">
                <div class="rowel">MC number</div>
                <div class="rower">{{ player.mcnum }}</div>
            </div>
            {% endif %}
            {% if player.tlpd_id or player.lp_name or player.sc2c_id or player.sc2e_id %}
                <div class="row infobox">
                    <div class="rowel">External</div>
                    <div class="rower">
                        {% if player.sc2c_id %}
                        <a href="http://www.sc2charts.net/en/edb/players/{{ player.sc2c_id }}" target="_blank">SC2C</a>
                        {% endif %}
                        {% with tlpds=player.get_tlpd_id %}
                            {% if tlpds.WoLbeta %}
                            <a href="http://www.teamliquid.net/tlpd/sc2-beta/players/{{ tlpds.WoLbeta }}"
                               target="_blank">TLPD:WoL:B</a>
                            {% endif %}
                            {% if tlpds.KR %}
                            <a href="http://www.teamliquid.net/tlpd/sc2-korean/players/{{ tlpds.KR }}"
                               target="_blank">TLPD:WoL:KR</a>
                            {% endif %}
                            {% if tlpds.IN %}
                            <a href="http://www.teamliquid.net/tlpd/sc2-international/players/{{ tlpds.IN }}"
                               target="_blank">TLPD:WoL:IN</a>
                            {% endif %}
                            {% if tlpds.HotS %}
                            <a href="http://www.teamliquid.net/tlpd/hots/players/{{ tlpds.HotS }}" 
                               target="_blank">TLPD:HotS</a>
                            {% endif %}
                            {% if tlpds.HotSbeta %}
                            <a href="http://www.teamliquid.net/tlpd/hots-beta/players/{{ tlpds.HotSbeta }}"
                               target="_blank">TLPD:HotS:B</a>
                            {% endif %}
                        {% endwith %}
                        {% if player.sc2e_id %}
                        <a href="http://sc2earnings.com/player/{{ player.sc2e_id }}" target="_blank">SC2E</a>
                        {% endif %}
                        {% if player.lp_name %}
                        <a href="http://wiki.teamliquid.net/starcraft2/{{ player.lp_name }}" target="_blank">LP</a>
                        {% endif %}
                    </div>
                </div>
            {% endif %}
        </div>
    </div>

{% if rating %}
<p>Standings:</p>

<div class="table" style="width: 30em;">
    <div class="row">
        <div class="rowel" style="width: 10em;">General</div>
        <div class="rower" style="width: 10em;">{{ rating.rating|ratscale }} 
            ± {{ rating.dev|ratscalediff }}
            {% if rating.position %}
                <span class="small">(#{{ rating.position }})</span>
            {% endif %}
        </div>
        <div class="rower" style="width: 10em">
            {% if total %}
            {{ total.0 }}/{{ total.1|add:total.0 }}
            <span class="small">({{ total.0|pctg_add:total.1 }}%)</span>
            {% endif %}
        </div>
    </div>
    <div class="row">
        <div class="rowel">vP</div>
        <div class="rower">{{ rating.rating|addf:rating.rating_vp|ratscale }} 
            ± {{ rating|ratingdev:"P"|ratscalediff }}
            {% if rating.position_vp %}
                <span class="small">(#{{ rating.position_vp }})</span>
            {% endif %}
        </div>
        <div class="rower">
            {% if vp %}
            {{ vp.0 }}/{{ vp.1|add:vp.0 }}
            <span class="small">({{ vp.0|pctg_add:vp.1 }}%)</span>
            {% endif %}
        </div>
    </div>
    <div class="row">
        <div class="rowel">vT</div>
        <div class="rower">{{ rating.rating|addf:rating.rating_vt|ratscale }} 
            ± {{ rating|ratingdev:"T"|ratscalediff }}
            {% if rating.position_vt %}
                <span class="small">(#{{ rating.position_vt }})</span>
            {% endif %}
        </div>
        <div class="rower">
            {% if vt %}
            {{ vt.0 }}/{{ vt.1|add:vt.0 }}
            <span class="small">({{ vt.0|pctg_add:vt.1 }}%)</span>
            {% endif %}
        </div>
    </div>
    <div class="row">
        <div class="rowel">vZ</div>
        <div class="rower">{{ rating.rating|addf:rating.rating_vz|ratscale }} 
            ± {{ rating|ratingdev:"Z"|ratscalediff }}
            {% if rating.position_vz %}
                <span class="small">(#{{ rating.position_vz }})</span>
            {% endif %}
        </div>
        <div class="rower">
            {% if vz %}
            {{ vz.0 }}/{{ vz.1|add:vz.0 }}
            <span class="small">({{ vz.0|pctg_add:vz.1 }}%)</span>
            {% endif %}
        </div>
    </div>
</div>

<p>Career highs:</p>

<div class="table" style="width: 30em;">
    <div class="row">
        <div class="rowel" style="width: 10em;">General</div>
        <div class="rower" style="width: 10em;">{{ highs.0.rating|ratscale }} 
            ± {{ highs.0.dev|ratscalediff }}
            {% if highs.0.position %}
                <span class="small">(#{{ highs.0.position }})</span>
            {% endif %}
        </div>
        <div class="rower" style="width: 10em">
            <a href="/periods/{{ highs.0.period.id }}/">{{ highs.0.period.end }}</a>
        </div>
    </div>
    <div class="row">
        <div class="rowel">vP</div>
        <div class="rower">{{ highs.1.rating|addf:highs.1.rating_vp|ratscale }} 
            ± {{ highs.1|ratingdev:"P"|ratscalediff }}
            {% if highs.1.position_vp %}
                <span class="small">(#{{ highs.1.position_vp }})</span>
            {% endif %}
        </div>
        <div class="rower">
            <a href="/periods/{{ highs.1.period.id }}/">{{ highs.1.period.end }}</a>
        </div>
    </div>
    <div class="row">
        <div class="rowel">vT</div>
        <div class="rower">{{ highs.2.rating|addf:highs.2.rating_vt|ratscale }} 
            ± {{ highs.2|ratingdev:"T"|ratscalediff }}
            {% if highs.2.position_vt %}
                <span class="small">(#{{ highs.2.position_vt }})</span>
            {% endif %}
        </div>
        <div class="rower">
            <a href="/periods/{{ highs.2.period.id }}/">{{ highs.2.period.end }}</a>
        </div>
    </div>
    <div class="row">
        <div class="rowel">vZ</div>
        <div class="rower">{{ highs.3.rating|addf:highs.3.rating_vz|ratscale }} 
            ± {{ highs.3|ratingdev:"Z"|ratscalediff }}
            {% if highs.3.position_vz %}
                <span class="small">(#{{ highs.3.position_vz }})</span>
            {% endif %}
        </div>
        <div class="rower">
            <a href="/periods/{{ highs.3.period.id }}/">{{ highs.3.period.end }}</a>
        </div>
    </div>
</div>

{% if adm %}
<div class="hiddenform" style="display: none;">
<table class="hiddenform bigform">
<form method="post" action="/players/{{ player.id }}-{{ player.tag|urlfilter }}/">
{% csrf_token %}
{% form "forms.html" %}
    {% field "basic"        form.tag        class="wideinput" %}
    {% field "select"       form.race       class="wideinput" %}
    {% field "select"       form.country    class="wideinput" %}
    {% field "basic"        form.name       class="wideinput" %}
    {% field "basic"        form.akas       class="wideinput" %}
    {% field "date"         form.birthday   class="wideinput" %}
    {% field "basic"        form.sc2c_id    class="wideinput" %}
    {% field "basic"        form.sc2e_id    class="wideinput" %}
    {% field "basic"        form.lp_name    class="wideinput" %}
    {% field "basic"        form.tlpd_id    class="wideinput" %}
    {% field "selectmulti"  form.tlpd_db    class="wideinput" %}
    {% use "submit" %}
{% endform %}
</table>
</form>
</div>
{% endif %}

{% if charts %}
<script type="text/javascript">
    $(document).ready(function() {
        var chart = new Highcharts.Chart({
            chart: {
                renderTo: 'chart',
                type: 'spline',
                zoomType: 'xy'
            },
            credits: {
                enabled: false
            },
            title: {
                text: 'Rating history for {{ player.tag }}'
            },
            subtitle: {
                text: 'Click and drag to zoom'
            },
            xAxis: {
                type: 'datetime',
                plotLines: [
                {% for p in patches %}
                {
                    value: {{ p.0|milliseconds }},
                    color: '#cccccc',
                    width: 2,
                    label: {
                        text: '{{ p.1 }}',
                        verticalAlign: 'bottom',
                        textAlign: 'right',
                        y: -2,
                        style: {
                            fontSize: '0.8em',
                        }
                    }
                },
                {% endfor %}]
            },
            yAxis: [{
                title: {
                    text: 'Rating'
                }
            }, {
                opposite: true,
                title: {
                    text: 'Games'
                }
            }],
            tooltip: {
                xDateFormat: '%B %e, %Y'
            },
            plotOptions: {
                series: {
                    point: {
                        events: {
                            click: function() {
                                if (this.hasOwnProperty('url'))
                                    window.location.href = this.url;
                            }
                        }
                    },
                    marker: {
                        enabled: false,
                        symbol: 'circle'
                    }
                },
            },
            tooltip: {
                formatter: function () {
                    return this.point.name;
                }
            },
            series: [{
                name: 'Games',
                color: 'rgba(100,100,100,0.4)',
                lineWidth: 5,
                enableMouseTracking: false,
                yAxis: 1,
                type: 'column',
                data: [{% for r in ratings %} {
                          x: {{ r.period.end|milliseconds }},
                          y: {{ r.ngames }}
                      },{% endfor %}]
            }, {
                name: 'vs. Protoss',
                color: '#00dd00',
                lineWidth: 1,
                dashStyle: 'Dash',
                enableMouseTracking: false,
                yAxis: 0,
                data: [{% for r in ratings %} {
                          name: '{{ r.period.end }} vP: {{r.bf_rating|addf:r.bf_rating_vp|ratscale }}',
                          x: {{ r.period.end|milliseconds }},
                          y: {{ r.bf_rating|addf:r.bf_rating_vp|ratscale }}
                      },{% endfor %}]
            }, {
                name: 'vs. Terran',
                color: '#0000dd',
                lineWidth: 1,
                dashStyle: 'Dash',
                enableMouseTracking: false,
                yAxis: 0,
                data: [{% for r in ratings %} {
                          name: '{{ r.period.end }} vT: {{r.bf_rating|addf:r.bf_rating_vt|ratscale }}',
                          x: {{ r.period.end|milliseconds }},
                          y: {{ r.bf_rating|addf:r.bf_rating_vt|ratscale }}
                      },{% endfor %}]
            }, {
                name: 'vs. Zerg',
                color: '#dd0000',
                lineWidth: 1,
                dashStyle: 'Dash',
                enableMouseTracking: false,
                yAxis: 0,
                data: [{% for r in ratings %} {
                          name: '{{ r.period.end }} vZ: {{r.bf_rating|addf:r.bf_rating_vz|ratscale }}',
                          x: {{ r.period.end|milliseconds }},
                          y: {{ r.bf_rating|addf:r.bf_rating_vz|ratscale }}
                      },{% endfor %}]
            }, {
                name: 'General',
                color: '#000000',
                lineWidth: 3,
                enableMouseTracking: false,
                yAxis: 0,
                data: [{% for r in ratings %} {
                          name: '{{ r.period.end }}: {{r.bf_rating|ratscale }}',
                          x: {{ r.period.end|milliseconds }},
                          y: {{ r.bf_rating|ratscale }}
                      },{% endfor %}]
            }, {% if stories %}
                {
                name: 'Stories',
                type: 'scatter',
                color: '#ffaa00',
                yAxis: 0,
                marker: {
                    enabled: true,
                    symbol: 'circle',
                    radius: 5
                },
                data: [{% for s in stories %}{% if not s.skip %} {
                          name: '{{s.text}}<br/>{{s.date}}{% if s.event %}: {{s.event.fullname}}{% endif %}',
                          url: '/results/events/{{s.event.id}}-{{s.event.fullname|urlfilter}}/',
                          x: {{ s.date|milliseconds }},
                          y: {{ s.rating|ratscale }}
                      },{% endif %}{% endfor %}]
            }, {% endif %}{% if teampoints %}
                {
                name: 'Team switches',
                type: 'scatter',
                color: '#FF0000',
                yAxis: 0,
                marker: {
                    enabled: true,
                    symbol: 'circle',
                    radius: 5
                },
                data: [{% for t in teampoints %} {
                          name: '{% for d in t.data %}{{d.date}}: {{player.tag}} {{d.jol}} {{d.team.name}}<br/>{% endfor %}',
                          x: {{ t.date|milliseconds }},
                          y: {{ t.rating|ratscale }}
                      },{% endfor %}]
            } {% endif %}]
        });
    });
</script>
<div id="chart" style="width: 67em; height: 30em; margin-top: 4em;"> </div>
{% endif %}
{% endif %}

{% if matches %}
<h3>Most recent results</h3>
<table class="results">
{% include "matchlist.html" with lm_list=matches lm_header="info" %}
</table>
{% endif %}

{% if teammems %}
<h3>Team history</h3>
<div class="table numtable" style="width: 67em;">
    <div class="rowh">
        <div class="rowe" style="width: 30em;">Team</div>
        <div class="rowe" style="width: 30em;">Joined</div>
        <div class="rowe" style="width: 30em;">Left</div>
        <div class="rowe" style="width: 7em; text-align: right;">Current</div>
    </div>
    {% for tm in teammems %}
    <div class="row {% cycle 'row2' 'row1' %}">
        <div class="rowe">
            <a href="/teams/{{ tm.group.id }}-{{ tm.group.name|urlfilter }}/">{{ tm.group.name }}</a>
        </div>
        <div class="rowe">{{ tm.start|date:"F jS, Y" }}</div>
        <div class="rowe">{{ tm.end|date:"F jS, Y" }}</div>
        <div class="rowe" style="text-align: right;">
            {% if tm.current %}
                <img src="{{ "yes.png"|static }}" alt="yes" class="btm" />
            {% else %}
                <img src="{{ "no.png"|static }}" alt="yes" class="btm" />
            {% endif %}
        </div>
    </div>
    {% endfor %}
</div>
{% endif %}

{% endblock %}
